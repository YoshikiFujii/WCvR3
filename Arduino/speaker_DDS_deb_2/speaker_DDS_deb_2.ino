#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>

#define F_CPU        16000000UL
#define SAMPLE_RATE  16000UL   // サンプル周波数 16 kHz
#define PWM_PIN      9         // OC1A (PB1)

// 256ポイント正弦テーブル（0–255: オフセット127で正弦波を表現）
const uint8_t PROGMEM SINE_TABLE[256] = {
    128, 131, 134, 137, 140, 144, 147, 150, 153, 156, 159, 162, 165, 168, 171, 174,
    177, 179, 182, 185, 188, 191, 193, 196, 199, 201, 204, 206, 209, 211, 213, 216,
    218, 220, 222, 224, 226, 228, 230, 232, 234, 235, 237, 239, 240, 241, 243, 244,
    245, 246, 248, 249, 250, 250, 251, 252, 253, 253, 254, 254, 254, 255, 255, 255,
    255, 255, 255, 255, 254, 254, 254, 253, 253, 252, 251, 250, 250, 249, 248, 246,
    245, 244, 243, 241, 240, 239, 237, 235, 234, 232, 230, 228, 226, 224, 222, 220,
    218, 216, 213, 211, 209, 206, 204, 201, 199, 196, 193, 191, 188, 185, 182, 179,
    177, 174, 171, 168, 165, 162, 159, 156, 153, 150, 147, 144, 140, 137, 134, 131,
    128, 125, 122, 119, 116, 112, 109, 106, 103, 100,  97,  94,  91,  88,  85,  82,
     79,  77,  74,  71,  68,  65,  63,  60,  57,  55,  52,  50,  47,  45,  43,  40,
     38,  36,  34,  32,  30,  28,  26,  24,  22,  21,  19,  17,  16,  15,  13,  12,
     11,  10,   8,   7,   6,   6,   5,   4,   3,   3,   2,   2,   2,   1,   1,   1,
      1,   1,   1,   1,   2,   2,   2,   3,   3,   4,   5,   6,   6,   7,   8,  10,
     11,  12,  13,  15,  16,  17,  19,  21,  22,  24,  26,  28,  30,  32,  34,  36,
     38,  40,  43,  45,  47,  50,  52,  55,  57,  60,  63,  65,  68,  71,  74,  77,
     79,  82,  85,  88,  91,  94,  97, 100, 103, 106, 109, 112, 116, 119, 122, 125
};

volatile uint32_t phase1 = 0, phase2 = 0;  // 位相位置（番目）
uint32_t inc1, inc2;                      // 一回の位相移動個数

ISR(TIMER2_COMPA_vect) {
  // フェーズを進める
  phase1 += inc1;
  phase2 += inc2;
  // 上位8bitを使ってテーブル参照
  uint8_t s1 = pgm_read_byte(&SINE_TABLE[phase1 >> 24]);
  uint8_t s2 = pgm_read_byte(&SINE_TABLE[phase2 >> 24]);
  // 合成・振幅調整
  uint16_t sum = (uint16_t)s1 + (uint16_t)s2;
  OCR1A = sum >> 1;  // 255に収まるよう1ビットシフト
}

void setup() {
  // PWMピンを出力に設定
  DDRB |= _BV(DDB1);  // digitalPin 9

  // ── Timer1: Fast PWM 10bit, non-inverting, prescaler=1
  TCCR1A = _BV(WGM11) | _BV(COM1A1);
  TCCR1B = _BV(WGM12) | _BV(CS10);

  // ── Timer2: CTC モード, prescaler=8
  TCCR2A = _BV(WGM21);
  TCCR2B = _BV(CS21);
  OCR2A  = (F_CPU/8/SAMPLE_RATE) - 1;      // (16MHz/8)/16kHz - 1 = 124
  TIMSK2 |= _BV(OCIE2A);                  // 割り込み許可

  // フェーズインクリメントを計算 (32bit累算器向け)
  // phase += inc; で 32bit フルレンジ(2^32) を 1 サンプルで進む量
  inc1 = (uint32_t)((uint64_t)1000UL * 4294967296UL / SAMPLE_RATE);  // 1 kHz
  inc2 = (uint32_t)((uint64_t)2000UL * 4294967296UL / SAMPLE_RATE);  // 2 kHz

  sei();  // グローバル割り込み有効化
}

void loop() {
  // メインループは空。ISRで波形生成
}
